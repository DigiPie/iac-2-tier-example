{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "AWS CloudFormation template for an example of a 2-tier Infrastructure-as-Code.",
  "Parameters": {
      "DBUser": {
          "NoEcho": "true",
          "Type": "String",
          "Description": "Test database admin account name",
          "MinLength": "1",
          "MaxLength": "16",
          "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*",
          "ConstraintDescription": "must begin with a letter and contain only alphanumeric characters."
      },
      "DBPassword": {
          "NoEcho": "true",
          "Type": "String",
          "Description": "Test database admin account password",
          "MinLength": "8",
          "MaxLength": "41",
          "AllowedPattern": "[a-zA-Z0-9]*",
          "ConstraintDescription": "must contain only alphanumeric characters."
      },
      "OperatorEMail": {
          "Description": "EMail address to notify if there are any operational issues",
          "Type": "String",
          "AllowedPattern": "([a-zA-Z0-9_\\-\\.]+)@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.)|(([a-zA-Z0-9\\-]+\\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\\]?)",
          "ConstraintDescription": "must be a valid email address."
      }
  },
  "Mappings": {
      "Region2Principal": {
          "ap-east-1": {
              "EC2Principal": "ec2.amazonaws.com",
              "OpsWorksPrincipal": "opsworks.amazonaws.com"
          },
          "ap-northeast-1": {
              "EC2Principal": "ec2.amazonaws.com",
              "OpsWorksPrincipal": "opsworks.amazonaws.com"
          },
          "ap-northeast-2": {
              "EC2Principal": "ec2.amazonaws.com",
              "OpsWorksPrincipal": "opsworks.amazonaws.com"
          },
          "ap-northeast-3": {
              "EC2Principal": "ec2.amazonaws.com",
              "OpsWorksPrincipal": "opsworks.amazonaws.com"
          },
          "ap-south-1": {
              "EC2Principal": "ec2.amazonaws.com",
              "OpsWorksPrincipal": "opsworks.amazonaws.com"
          },
          "ap-southeast-1": {
              "EC2Principal": "ec2.amazonaws.com",
              "OpsWorksPrincipal": "opsworks.amazonaws.com"
          },
          "ap-southeast-2": {
              "EC2Principal": "ec2.amazonaws.com",
              "OpsWorksPrincipal": "opsworks.amazonaws.com"
          },
          "ca-central-1": {
              "EC2Principal": "ec2.amazonaws.com",
              "OpsWorksPrincipal": "opsworks.amazonaws.com"
          },
          "cn-north-1": {
              "EC2Principal": "ec2.amazonaws.com.cn",
              "OpsWorksPrincipal": "opsworks.amazonaws.com.cn"
          },
          "cn-northwest-1": {
              "EC2Principal": "ec2.amazonaws.com.cn",
              "OpsWorksPrincipal": "opsworks.amazonaws.com.cn"
          },
          "eu-central-1": {
              "EC2Principal": "ec2.amazonaws.com",
              "OpsWorksPrincipal": "opsworks.amazonaws.com"
          },
          "eu-north-1": {
              "EC2Principal": "ec2.amazonaws.com",
              "OpsWorksPrincipal": "opsworks.amazonaws.com"
          },
          "eu-west-1": {
              "EC2Principal": "ec2.amazonaws.com",
              "OpsWorksPrincipal": "opsworks.amazonaws.com"
          },
          "eu-west-2": {
              "EC2Principal": "ec2.amazonaws.com",
              "OpsWorksPrincipal": "opsworks.amazonaws.com"
          },
          "eu-west-3": {
              "EC2Principal": "ec2.amazonaws.com",
              "OpsWorksPrincipal": "opsworks.amazonaws.com"
          },
          "me-south-1": {
              "EC2Principal": "ec2.amazonaws.com",
              "OpsWorksPrincipal": "opsworks.amazonaws.com"
          },
          "sa-east-1": {
              "EC2Principal": "ec2.amazonaws.com",
              "OpsWorksPrincipal": "opsworks.amazonaws.com"
          },
          "us-east-1": {
              "EC2Principal": "ec2.amazonaws.com",
              "OpsWorksPrincipal": "opsworks.amazonaws.com"
          },
          "us-east-2": {
              "EC2Principal": "ec2.amazonaws.com",
              "OpsWorksPrincipal": "opsworks.amazonaws.com"
          },
          "us-west-1": {
              "EC2Principal": "ec2.amazonaws.com",
              "OpsWorksPrincipal": "opsworks.amazonaws.com"
          },
          "us-west-2": {
              "EC2Principal": "ec2.amazonaws.com",
              "OpsWorksPrincipal": "opsworks.amazonaws.com"
          }
      }
  },
  "Conditions": {
      "Is-EC2-VPC": {
          "Fn::Or": [
              {
                  "Fn::Equals": [
                      {
                          "Ref": "AWS::Region"
                      },
                      "eu-central-1"
                  ]
              },
              {
                  "Fn::Equals": [
                      {
                          "Ref": "AWS::Region"
                      },
                      "cn-north-1"
                  ]
              }
          ]
      },
      "Is-EC2-Classic": {
          "Fn::Not": [
              {
                  "Condition": "Is-EC2-VPC"
              }
          ]
      }
  },
  "Resources": {
      "WebServerRole": {
          "Type": "AWS::IAM::Role",
          "Properties": {
              "AssumeRolePolicyDocument": {
                  "Statement": [
                      {
                          "Effect": "Allow",
                          "Principal": {
                              "Service": [
                                  {
                                      "Fn::FindInMap": [
                                          "Region2Principal",
                                          {
                                              "Ref": "AWS::Region"
                                          },
                                          "EC2Principal"
                                      ]
                                  }
                              ]
                          },
                          "Action": [
                              "sts:AssumeRole"
                          ]
                      }
                  ]
              },
              "Path": "/"
          },
          "Metadata": {
              "AWS::CloudFormation::Designer": {
                  "id": "c570539f-3945-4df5-bcbf-72d76e17a02a"
              }
          }
      },
      "WebServerRolePolicy": {
          "Type": "AWS::IAM::Policy",
          "Properties": {
              "PolicyName": "WebServerRole",
              "PolicyDocument": {
                  "Statement": [
                      {
                          "Effect": "Allow",
                          "NotAction": "iam:*",
                          "Resource": "*"
                      }
                  ]
              },
              "Roles": [
                  {
                      "Ref": "WebServerRole"
                  }
              ]
          },
          "Metadata": {
              "AWS::CloudFormation::Designer": {
                  "id": "25846244-c61c-4d22-aee1-acfa50497b0a"
              }
          }
      },
      "WebServerInstanceProfile": {
          "Type": "AWS::IAM::InstanceProfile",
          "Properties": {
              "Path": "/",
              "Roles": [
                  {
                      "Ref": "WebServerRole"
                  }
              ]
          },
          "Metadata": {
              "AWS::CloudFormation::Designer": {
                  "id": "bb60d180-6a93-4167-99d2-89e76d55537f"
              }
          }
      },
      "SymbiosisApp": {
          "Type": "AWS::ElasticBeanstalk::Application",
          "Properties": {
              "Description": "AWS Elastic Beanstalk Sample Application"
          },
          "Metadata": {
              "AWS::CloudFormation::Designer": {
                  "id": "f8f022fe-5b50-4924-9f1e-225eda8223d0"
              }
          }
      },
      "SampleApplicationVersion": {
          "Type": "AWS::ElasticBeanstalk::ApplicationVersion",
          "Properties": {
              "Description": "Version 1.0",
              "ApplicationName": {
                  "Ref": "SampleApplication"
              },
              "SourceBundle": {
                  "S3Bucket": {
                      "Fn::Join": [
                          "-",
                          [
                              "cloudformation-examples",
                              {
                                  "Ref": "AWS::Region"
                              }
                          ]
                      ]
                  },
                  "S3Key": "CloudFormationBeanstalkRDSExample.war"
              }
          },
          "Metadata": {
              "AWS::CloudFormation::Designer": {
                  "id": "5003ca2c-7a5c-4dde-baed-97c72a0e0bc2"
              }
          }
      },
      "SampleConfigurationTemplate": {
          "Type": "AWS::ElasticBeanstalk::ConfigurationTemplate",
          "Properties": {
              "ApplicationName": {
                  "Ref": "SampleApplication"
              },
              "Description": "Default Configuration Version 1.0",
              "SolutionStackName": "64bit Amazon Linux 2018.03 v3.0.7 running Tomcat 7 Java 7",
              "OptionSettings": [
                  {
                      "Namespace": "aws:elasticbeanstalk:application:environment",
                      "OptionName": "JDBC_CONNECTION_STRING",
                      "Value": {
                          "Fn::Join": [
                              "",
                              [
                                  "jdbc:mysql://",
                                  {
                                      "Fn::GetAtt": [
                                          "MasterDB",
                                          "Endpoint.Address"
                                      ]
                                  },
                                  ":",
                                  {
                                      "Fn::GetAtt": [
                                          "MasterDB",
                                          "Endpoint.Port"
                                      ]
                                  },
                                  "/beanstalkdb"
                              ]
                          ]
                      }
                  },
                  {
                      "Namespace": "aws:elasticbeanstalk:application:environment",
                      "OptionName": "PARAM1",
                      "Value": {
                          "Ref": "DBUser"
                      }
                  },
                  {
                      "Namespace": "aws:elasticbeanstalk:application:environment",
                      "OptionName": "PARAM2",
                      "Value": {
                          "Ref": "DBPassword"
                      }
                  },
                  {
                      "Namespace": "aws:autoscaling:launchconfiguration",
                      "OptionName": "SecurityGroups",
                      "Value": {
                          "Ref": "InstanceSecurityGroup"
                      }
                  },
                  {
                      "Namespace": "aws:autoscaling:launchconfiguration",
                      "OptionName": "IamInstanceProfile",
                      "Value": {
                          "Ref": "WebServerInstanceProfile"
                      }
                  }
              ]
          },
          "Metadata": {
              "AWS::CloudFormation::Designer": {
                  "id": "9a64effb-d239-446f-9b89-9b459be27c9a"
              }
          }
      },
      "SampleEnvironment": {
          "Type": "AWS::ElasticBeanstalk::Environment",
          "Properties": {
              "Description": "AWS Elastic Beanstalk Environment running Sample Application",
              "ApplicationName": {
                  "Ref": "SampleApplication"
              },
              "TemplateName": {
                  "Ref": "SampleConfigurationTemplate"
              },
              "VersionLabel": {
                  "Ref": "SampleApplicationVersion"
              }
          },
          "Metadata": {
              "AWS::CloudFormation::Designer": {
                  "id": "4f0cc0bd-9086-4978-8487-5f0fb0130d91"
              }
          }
      },
      "InstanceSecurityGroup": {
          "Type": "AWS::EC2::SecurityGroup",
          "Properties": {
              "GroupDescription": "RDS allows ingress from EC2 instances in this group.",
              "SecurityGroupIngress": []
          },
          "Metadata": {
              "AWS::CloudFormation::Designer": {
                  "id": "539c5d5f-77fa-4f04-bf38-210b3e6bbd43"
              }
          }
      },
      "DBEC2SecurityGroup": {
          "Type": "AWS::EC2::SecurityGroup",
          "Condition": "Is-EC2-VPC",
          "Properties": {
              "GroupDescription": "Open database for access",
              "SecurityGroupIngress": [
                  {
                      "IpProtocol": "tcp",
                      "FromPort": "3306",
                      "ToPort": "3306",
                      "SourceSecurityGroupName": {
                          "Ref": "InstanceSecurityGroup"
                      }
                  }
              ]
          },
          "Metadata": {
              "AWS::CloudFormation::Designer": {
                  "id": "08ec26ec-f855-4f6c-98d2-229d0a08b367"
              }
          }
      },
      "DBSecurityGroup": {
          "Type": "AWS::RDS::DBSecurityGroup",
          "Condition": "Is-EC2-Classic",
          "Properties": {
              "DBSecurityGroupIngress": {
                  "EC2SecurityGroupName": {
                      "Ref": "InstanceSecurityGroup"
                  }
              },
              "GroupDescription": "database access"
          },
          "Metadata": {
              "AWS::CloudFormation::Designer": {
                  "id": "871aeac7-040f-4ff1-b2cb-bab8327d8f02"
              }
          }
      },
      "MasterDB": {
          "Type": "AWS::RDS::DBInstance",
          "Properties": {
              "Engine": "MySQL",
              "DBName": "beanstalkdb",
              "MasterUsername": {
                  "Ref": "DBUser"
              },
              "DBInstanceClass": "db.t2.small",
              "AllocatedStorage": "5",
              "MasterUserPassword": {
                  "Ref": "DBPassword"
              },
              "Tags": [
                  {
                      "Key": "Name",
                      "Value": "Master Database"
                  }
              ],
              "VPCSecurityGroups": {
                  "Fn::If": [
                      "Is-EC2-VPC",
                      [
                          {
                              "Fn::GetAtt": [
                                  "DBEC2SecurityGroup",
                                  "GroupId"
                              ]
                          }
                      ],
                      {
                          "Ref": "AWS::NoValue"
                      }
                  ]
              },
              "DBSecurityGroups": {
                  "Fn::If": [
                      "Is-EC2-Classic",
                      [
                          {
                              "Ref": "DBSecurityGroup"
                          }
                      ],
                      {
                          "Ref": "AWS::NoValue"
                      }
                  ]
              }
          },
          "Metadata": {
              "AWS::CloudFormation::Designer": {
                  "id": "3975bfe3-c501-453b-abf9-638eca443bc5"
              }
          }
      },
      "AlarmTopic": {
          "Type": "AWS::SNS::Topic",
          "Properties": {
              "Subscription": [
                  {
                      "Endpoint": {
                          "Ref": "OperatorEMail"
                      },
                      "Protocol": "email"
                  }
              ]
          },
          "Metadata": {
              "AWS::CloudFormation::Designer": {
                  "id": "a3522504-32c5-4c39-a246-a3e44b9734d3"
              }
          }
      },
      "CPUAlarmHigh": {
          "Type": "AWS::CloudWatch::Alarm",
          "Properties": {
              "EvaluationPeriods": "10",
              "Statistic": "Average",
              "Threshold": "50",
              "AlarmDescription": "Alarm if CPU too high or metric disappears indicating the RDS database instance is having issues",
              "Period": "60",
              "Namespace": "AWS/RDS",
              "MetricName": "CPUUtilization",
              "Dimensions": [
                  {
                      "Name": "DBInstanceIdentifier",
                      "Value": {
                          "Ref": "MasterDB"
                      }
                  }
              ],
              "ComparisonOperator": "GreaterThanThreshold",
              "AlarmActions": [
                  {
                      "Ref": "AlarmTopic"
                  }
              ],
              "InsufficientDataActions": [
                  {
                      "Ref": "AlarmTopic"
                  }
              ]
          },
          "Metadata": {
              "AWS::CloudFormation::Designer": {
                  "id": "90d3f7d0-77b5-462c-ad02-e165b50e4a08"
              }
          }
      }
  },
  "Outputs": {
      "URL": {
          "Description": "URL of the AWS Elastic Beanstalk Environment",
          "Value": {
              "Fn::Join": [
                  "",
                  [
                      "http://",
                      {
                          "Fn::GetAtt": [
                              "SampleEnvironment",
                              "EndpointURL"
                          ]
                      }
                  ]
              ]
          }
      }
  },
  "Metadata": {
      "AWS::CloudFormation::Designer": {
          "a3522504-32c5-4c39-a246-a3e44b9734d3": {
              "size": {
                  "width": 60,
                  "height": 60
              },
              "position": {
                  "x": 870,
                  "y": 290
              },
              "z": 1,
              "embeds": []
          },
          "539c5d5f-77fa-4f04-bf38-210b3e6bbd43": {
              "size": {
                  "width": 60,
                  "height": 60
              },
              "position": {
                  "x": 870,
                  "y": 450
              },
              "z": 1,
              "embeds": []
          },
          "871aeac7-040f-4ff1-b2cb-bab8327d8f02": {
              "size": {
                  "width": 60,
                  "height": 60
              },
              "position": {
                  "x": 770,
                  "y": 390
              },
              "z": 1,
              "embeds": []
          },
          "08ec26ec-f855-4f6c-98d2-229d0a08b367": {
              "size": {
                  "width": 60,
                  "height": 60
              },
              "position": {
                  "x": 770,
                  "y": 510
              },
              "z": 1,
              "embeds": []
          },
          "3975bfe3-c501-453b-abf9-638eca443bc5": {
              "size": {
                  "width": 60,
                  "height": 60
              },
              "position": {
                  "x": 660,
                  "y": 390
              },
              "z": 1,
              "embeds": [],
              "isassociatedwith": [
                  "871aeac7-040f-4ff1-b2cb-bab8327d8f02"
              ]
          },
          "90d3f7d0-77b5-462c-ad02-e165b50e4a08": {
              "size": {
                  "width": 60,
                  "height": 60
              },
              "position": {
                  "x": 770,
                  "y": 290
              },
              "z": 1,
              "embeds": []
          },
          "f8f022fe-5b50-4924-9f1e-225eda8223d0": {
              "size": {
                  "width": 230,
                  "height": 260
              },
              "position": {
                  "x": 970,
                  "y": 340
              },
              "z": 1,
              "embeds": [
                  "5003ca2c-7a5c-4dde-baed-97c72a0e0bc2",
                  "9a64effb-d239-446f-9b89-9b459be27c9a",
                  "4f0cc0bd-9086-4978-8487-5f0fb0130d91"
              ]
          },
          "5003ca2c-7a5c-4dde-baed-97c72a0e0bc2": {
              "size": {
                  "width": 60,
                  "height": 60
              },
              "position": {
                  "x": 1110,
                  "y": 520
              },
              "z": 2,
              "parent": "f8f022fe-5b50-4924-9f1e-225eda8223d0",
              "embeds": [],
              "iscontainedinside": [
                  "f8f022fe-5b50-4924-9f1e-225eda8223d0",
                  "f8f022fe-5b50-4924-9f1e-225eda8223d0",
                  "f8f022fe-5b50-4924-9f1e-225eda8223d0",
                  "f8f022fe-5b50-4924-9f1e-225eda8223d0",
                  "f8f022fe-5b50-4924-9f1e-225eda8223d0",
                  "f8f022fe-5b50-4924-9f1e-225eda8223d0"
              ]
          },
          "c570539f-3945-4df5-bcbf-72d76e17a02a": {
              "size": {
                  "width": 60,
                  "height": 60
              },
              "position": {
                  "x": 1250,
                  "y": 490
              },
              "z": 1,
              "embeds": []
          },
          "bb60d180-6a93-4167-99d2-89e76d55537f": {
              "size": {
                  "width": 60,
                  "height": 60
              },
              "position": {
                  "x": 1250,
                  "y": 390
              },
              "z": 1,
              "embeds": [],
              "isassociatedwith": [
                  "c570539f-3945-4df5-bcbf-72d76e17a02a"
              ]
          },
          "9a64effb-d239-446f-9b89-9b459be27c9a": {
              "size": {
                  "width": 60,
                  "height": 60
              },
              "position": {
                  "x": 1000,
                  "y": 390
              },
              "z": 2,
              "parent": "f8f022fe-5b50-4924-9f1e-225eda8223d0",
              "embeds": [],
              "iscontainedinside": [
                  "f8f022fe-5b50-4924-9f1e-225eda8223d0",
                  "f8f022fe-5b50-4924-9f1e-225eda8223d0",
                  "f8f022fe-5b50-4924-9f1e-225eda8223d0",
                  "f8f022fe-5b50-4924-9f1e-225eda8223d0",
                  "f8f022fe-5b50-4924-9f1e-225eda8223d0",
                  "f8f022fe-5b50-4924-9f1e-225eda8223d0"
              ]
          },
          "4f0cc0bd-9086-4978-8487-5f0fb0130d91": {
              "size": {
                  "width": 60,
                  "height": 60
              },
              "position": {
                  "x": 1000,
                  "y": 520
              },
              "z": 2,
              "parent": "f8f022fe-5b50-4924-9f1e-225eda8223d0",
              "embeds": [],
              "isassociatedwith": [
                  "9a64effb-d239-446f-9b89-9b459be27c9a"
              ],
              "iscontainedinside": [
                  "f8f022fe-5b50-4924-9f1e-225eda8223d0",
                  "f8f022fe-5b50-4924-9f1e-225eda8223d0",
                  "f8f022fe-5b50-4924-9f1e-225eda8223d0",
                  "f8f022fe-5b50-4924-9f1e-225eda8223d0",
                  "f8f022fe-5b50-4924-9f1e-225eda8223d0",
                  "f8f022fe-5b50-4924-9f1e-225eda8223d0"
              ]
          },
          "25846244-c61c-4d22-aee1-acfa50497b0a": {
              "size": {
                  "width": 60,
                  "height": 60
              },
              "position": {
                  "x": 1350,
                  "y": 490
              },
              "z": 1,
              "embeds": [],
              "isassociatedwith": [
                  "c570539f-3945-4df5-bcbf-72d76e17a02a"
              ]
          },
          "81d5c59e-5fe0-4e4b-8f3b-55e76e23bbe1": {
              "size": {
                  "width": 60,
                  "height": 60
              },
              "position": {
                  "x": 540,
                  "y": 390
              },
              "z": 0,
              "embeds": [],
              "isassociatedwith": [
                  "871aeac7-040f-4ff1-b2cb-bab8327d8f02",
                  "3975bfe3-c501-453b-abf9-638eca443bc5"
              ]
          }
      }
  }
}